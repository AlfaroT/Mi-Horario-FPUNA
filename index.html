<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Mi Horario FPUNA - Gestiona tu horario de clases y ex√°menes">
    
    <title>Mi Horario FPUNA</title>
    
    <!-- Tailwind CSS (CDN para desarrollo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuraci√≥n de Tailwind
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWkgSG9yYXJpbyBGUFVOQSIsInNob3J0X25hbWUiOiJIb3JhcmlvIEZQVU5BIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXlOQ0F5TkNJK1BISmxZM1FnZUQwaU1DSWdlVDBpTUNJZ2QybGtkR2c5SWpJMElpQm9aV2xuYUhROUlqSTBJaUJtYVd4c1BTSWpNalUyTTJWaUlpOCtQSFJsZUhRZ2VEMGlNVElpSUhrOUlqWWlJR1pwYkd3OUluZG9hWFJsSWlCbWIyNTBMWE5wZW1VOUlqRXdJaUJtYjI1MExXWmhiV2xzZVQwaVlYSnBZV3dpSUhSbGVIUXRZVzVqYUc5eVBTSnRhV1JrYkdVaVBrZ3dNVHd2ZEdWNGRENDhMM04yWno0PSIsInNpemVzIjoiMjR4MjQiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        /* Estilos personalizados */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .card {
            @apply bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4;
        }
        
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200;
        }
        
        .btn-secondary {
            @apply bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .badge-exam {
            @apply inline-block px-2 py-1 text-xs font-semibold rounded;
        }
        
        .badge-parcial {
            @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
        }
        
        .badge-final {
            @apply bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200;
        }
        
        .badge-revision {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
        }
        
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50;
        }
        
        .modal-content {
            @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.dark {
            background: #1f2937;
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes modalSlideDown {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .btn-primary, .btn-secondary {
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
        }
        
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .modal-content {
            animation: modalSlideDown 0.3s ease-out;
        }
        
        /* FAB (Floating Action Button) */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 40;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    
    <!-- Pantalla de Configuraci√≥n Inicial -->
    <div id="setupScreen" class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="text-center mb-8">
            <i class="fas fa-calendar-alt text-6xl text-blue-600 mb-4"></i>
            <h1 class="text-3xl font-bold mb-2">Mi Horario FPUNA</h1>
            <p class="text-gray-600 dark:text-gray-400">Gestiona tu horario de clases y ex√°menes</p>
        </div>
        
        <div class="card">
            <h2 class="text-xl font-semibold mb-6 text-center">Configuraci√≥n Inicial</h2>
            
            <!-- Paso 0: Pantalla de Inicio con 2 Opciones -->
            <div id="step0" class="mb-6">
                <p class="text-center text-gray-600 dark:text-gray-400 mb-6">
                    Para comenzar, necesitas el archivo de horarios oficial de la FPUNA
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Bot√≥n para Descargar -->
                    <a href="https://www.pol.una.py/academico/horarios-de-clases-y-examenes/" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="flex flex-col items-center justify-center p-6 bg-green-50 dark:bg-green-900/20 border-2 border-green-500 dark:border-green-600 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-all group">
                        <i class="fas fa-download text-4xl text-green-600 dark:text-green-400 mb-3 group-hover:scale-110 transition-transform"></i>
                        <h3 class="font-bold text-lg text-green-700 dark:text-green-300 mb-2">Descargar Horario</h3>
                        <p class="text-sm text-green-600 dark:text-green-400 text-center">
                            Ir al sitio oficial de la FPUNA
                        </p>
                    </a>
                    
                    <!-- Bot√≥n para Cargar Archivo -->
                    <label for="fileInput" 
                           class="flex flex-col items-center justify-center p-6 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 dark:border-blue-600 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all cursor-pointer group">
                        <i class="fas fa-file-excel text-4xl text-blue-600 dark:text-blue-400 mb-3 group-hover:scale-110 transition-transform"></i>
                        <h3 class="font-bold text-lg text-blue-700 dark:text-blue-300 mb-2">Cargar Horario</h3>
                        <p class="text-sm text-blue-600 dark:text-blue-400 text-center">
                            Seleccionar archivo .xlsx
                        </p>
                    </label>
                </div>
                
                <input type="file" id="fileInput" accept=".xlsx" class="hidden">
                <div id="fileError" class="text-red-600 text-sm mt-2 hidden"></div>
            </div>
            
            <!-- Paso 1: Ya no es necesario, se fusion√≥ con step0 -->
            
            <!-- Spinner de carga -->
            <div id="loadingSpinner" class="hidden flex flex-col items-center justify-center py-8">
                <div class="spinner mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400">Procesando archivo...</p>
            </div>
            
            <!-- Paso 2: Seleccionar Carrera -->
            <div id="step2" class="mb-6 hidden">
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-graduation-cap mr-2"></i>Paso 1: Selecciona tu carrera
                </label>
                <select id="carreraSelect" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">-- Selecciona una carrera --</option>
                </select>
            </div>
            
            <!-- Paso 3: Filtros con Cascada -->
            <div id="step3" class="mb-6 hidden">
                <label class="block text-sm font-medium mb-4">
                    <i class="fas fa-filter mr-2"></i>Paso 2: Configura tu horario
                </label>
                
                <!-- Paso 3.1: Selecci√≥n de Semestres -->
                <div class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-md font-semibold mb-3 text-blue-600 dark:text-blue-400">
                        <i class="fas fa-graduation-cap mr-2"></i>Paso 3.1: Selecciona tus Semestres
                    </h3>
                    <div id="semestreCheckboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                </div>
                
                <!-- Paso 3.2: Selecci√≥n de Asignaturas -->
                <div id="asignaturasSection" class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700 hidden">
                    <h3 class="text-md font-semibold mb-3 text-green-600 dark:text-green-400">
                        <i class="fas fa-book mr-2"></i>Paso 3.2: Ahora, elige tus materias
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Mostrando materias de los semestres seleccionados
                    </p>
                    <div id="asignaturaCheckboxes" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-96 overflow-y-auto"></div>
                </div>
                
                <!-- Paso 3.3: Selecci√≥n de Instancias (Secci√≥n/Turno/Profesor) -->
                <div id="instanciasSection" class="mb-6 hidden">
                    <h3 class="text-md font-semibold mb-3 text-purple-600 dark:text-purple-400">
                        <i class="fas fa-tasks mr-2"></i>Paso 3.3: Selecciona las clases espec√≠ficas
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Algunas materias tienen m√∫ltiples secciones. Elige cu√°les cursar√°s.
                    </p>
                    <div id="instanciaCheckboxes" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
            
            <!-- Bot√≥n Guardar -->
            <div id="step4" class="hidden">
                <button id="saveConfigBtn" class="btn-primary w-full">
                    <i class="fas fa-check mr-2"></i>Generar Mi Horario
                </button>
            </div>
        </div>
    </div>
    
    <!-- Vista Principal (Dashboard) -->
    <div id="dashboardScreen" class="hidden">
        <!-- Header -->
        <div class="bg-blue-600 dark:bg-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold">Mi Horario</h1>
                        <p id="currentDate" class="text-sm text-blue-100"></p>
                    </div>
                    <div class="flex gap-2">
                        <button id="gradeCalculatorBtn" class="text-white hover:bg-blue-700 dark:hover:bg-blue-900 p-3 rounded-lg transition-colors" title="Calculadora de Notas">
                            <i class="fas fa-calculator text-2xl"></i>
                        </button>
                        <button id="settingsBtn" class="text-white hover:bg-blue-700 dark:hover:bg-blue-900 p-3 rounded-lg transition-colors" title="Ajustes">
                            <i class="fas fa-cog text-2xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAREA #1 v1.1: BOTONES DE ACCESO DIRECTO COMPACTOS -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border-b border-gray-200 dark:border-gray-600">
            <div class="container mx-auto px-4 py-4 max-w-4xl">
                <div class="flex flex-wrap justify-center gap-4">
                    <!-- Bot√≥n EALU -->
                    <a href="https://www.cnc.una.py/ealu/#/pages/login?returnUrl=%2Fperfil%2Fcedula-universitaria" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:scale-105 hover:shadow-lg group">
                        <i class="fas fa-graduation-cap text-lg group-hover:rotate-12 transition-transform"></i>
                        <span>.::EALU::.</span>
                        <i class="fas fa-external-link-alt text-xs opacity-75"></i>
                    </a>
                    
                    <!-- Bot√≥n EDUCA -->
                    <a href="https://grado.pol.una.py/login/index.php" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="inline-flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:scale-105 hover:shadow-lg group">
                        <i class="fas fa-book-open text-lg group-hover:rotate-12 transition-transform"></i>
                        <span>Entrar al sitio | educa</span>
                        <i class="fas fa-external-link-alt text-xs opacity-75"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal -->
        <div class="container mx-auto px-4 py-6 max-w-4xl">
            
            <!-- Clases de Hoy -->
            <section class="mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-calendar-day text-blue-600 mr-2"></i>
                    Clases de Hoy
                </h2>
                <div id="todayClasses"></div>
            </section>
            
            <!-- Pr√≥ximos Ex√°menes -->
            <section class="mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-clipboard-check text-red-600 mr-2"></i>
                    Pr√≥ximos Ex√°menes y Revisiones
                </h2>
                <div id="upcomingExams"></div>
            </section>
            
            <!-- Pr√≥ximas Clases Ocasionales -->
            <section class="mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-calendar-day text-purple-600 mr-2"></i>
                    Pr√≥ximas Clases Ocasionales
                </h2>
                <div id="occasionalClasses"></div>
            </section>
            
            <!-- Mis Tareas y Objetivos -->
            <section class="mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-clipboard-list text-green-600 mr-2"></i>
                    Mis Tareas y Objetivos
                </h2>
                <div id="userTasksContainer"></div>
            </section>
            
            <!-- Historial de Tareas Completadas -->
            <section class="mb-8">
                <button id="toggleHistoryBtn" class="w-full text-left flex items-center justify-between bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-4 rounded-lg transition-colors">
                    <div class="flex items-center">
                        <i class="fas fa-history text-gray-600 dark:text-gray-400 mr-2"></i>
                        <h2 class="text-xl font-bold">Historial de Tareas Completadas</h2>
                    </div>
                    <i id="historyToggleIcon" class="fas fa-chevron-down text-gray-600 dark:text-gray-400 transition-transform"></i>
                </button>
                <div id="taskHistoryContainer" class="hidden mt-4"></div>
            </section>
            
        </div>
        
        <!-- Bot√≥n Flotante para A√±adir Tarea -->
        <button id="addTaskFab" class="fab bg-green-600 hover:bg-green-700 text-white flex items-center justify-center" title="A√±adir Tarea">
            <i class="fas fa-plus text-2xl"></i>
        </button>
    </div>
    
    <!-- Modal de Ajustes -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 transition-opacity">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Ajustes</h3>
                    <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- Selector de Tema -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-moon text-xl mr-3 text-gray-600 dark:text-gray-300"></i>
                            <span class="font-medium">Modo Oscuro</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="themeToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <!-- Modificar Filtros -->
                    <button id="modifyFiltersBtn" class="w-full btn-secondary flex items-center justify-center">
                        <i class="fas fa-edit mr-2"></i>
                        Modificar Mis Filtros
                    </button>
                    
                    <!-- Exportar JSON -->
                    <button id="exportBtn" class="w-full btn-secondary flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>
                        Exportar a JSON
                    </button>
                    
                    <!-- Importar JSON -->
                    <div>
                        <label for="importInput" class="w-full btn-secondary flex items-center justify-center cursor-pointer">
                            <i class="fas fa-upload mr-2"></i>
                            Importar JSON
                        </label>
                        <input type="file" id="importInput" accept=".json" class="hidden">
                    </div>
                    
                    <!-- Reiniciar App -->
                    <button id="resetBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        <i class="fas fa-redo mr-2"></i>
                        Reiniciar App
                    </button>
                    
                    <!-- Info -->
                    <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                            Mi Horario FPUNA v1.0<br>
                            Progressive Web App<br>
                            <span class="text-green-600 dark:text-green-400">‚úì Versi√≥n Final Completa</span><br>
                            <span class="text-green-600 dark:text-green-400">‚úì Todas las funciones activas</span><br>
                            <span class="text-green-600 dark:text-green-400">‚úì UI redise√±ada</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmaci√≥n para Reiniciar -->
    <div id="confirmModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 transition-opacity">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-sm w-full m-4">
            <div class="p-6">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-3"></i>
                    <h3 class="text-xl font-bold mb-2">¬øEst√°s seguro?</h3>
                    <p class="text-gray-600 dark:text-gray-400">
                        Se borrar√°n todos los datos guardados y la aplicaci√≥n se reiniciar√°.
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <button id="confirmResetBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        Confirmar Borrado
                    </button>
                    <button id="cancelResetBtn" class="flex-1 btn-secondary">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Calculadora de Notas -->
    <div id="gradeCalculatorModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 transition-opacity">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-calculator text-blue-600 mr-2"></i>
                        Calculadora de Nota Final
                    </h3>
                    <button id="closeGradeCalculatorBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Promedio Ponderado de Procesos (PP)
                        </label>
                        <input type="number" id="ppInput" min="0" max="100" step="0.1" 
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ejemplo: 75">
                        <p class="text-xs text-gray-500 mt-1">Promedio de 0 a 100</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Puntuaci√≥n del Examen Final (EF)
                        </label>
                        <input type="number" id="efInput" min="0" max="100" step="0.1" 
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ejemplo: 80">
                        <p class="text-xs text-gray-500 mt-1">Puntuaci√≥n de 0 a 100</p>
                    </div>
                    
                    <button id="calculateGradeBtn" class="w-full btn-primary">
                        <i class="fas fa-calculator mr-2"></i>
                        Calcular Nota Final
                    </button>
                </div>
                
                <div id="gradeResult" class="min-h-20"></div>
                
                <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                    <p class="text-xs text-gray-600 dark:text-gray-400">
                        <strong>F√≥rmula FPUNA:</strong> PF = (0.4 √ó PP) + (0.6 √ó EF)<br>
                        <strong>Nota m√≠nima EF:</strong> 50 puntos para aprobar<br>
                        <strong>Escala:</strong> 90-100: Excelente (5) | 80-89: Muy Bueno (4) | 70-79: Bueno (3) | 60-69: Regular (2) | 0-59: Reprobado (1)
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Gestor de Tareas -->
    <div id="taskModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 transition-opacity">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="taskModalTitle" class="text-xl font-bold flex items-center">
                        <i class="fas fa-tasks text-green-600 mr-2"></i>
                        Nueva Tarea
                    </h3>
                    <button id="closeTaskModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <input type="hidden" id="taskId">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            T√≠tulo <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="taskTitle" 
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="Ej: Entregar proyecto de programaci√≥n"
                               required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Descripci√≥n
                        </label>
                        <textarea id="taskDescription" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                  placeholder="Detalles adicionales..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                Fecha de Vencimiento <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="taskDate" 
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                Hora
                            </label>
                            <input type="time" id="taskTime" 
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button id="saveTaskBtn" class="flex-1 btn-primary">
                            <i class="fas fa-save mr-2"></i>
                            Guardar
                        </button>
                        <button id="cancelTaskBtn" class="flex-1 btn-secondary">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SheetJS Library -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- date-fns Library (usando CDN UMD compatible con navegador) -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    
    <!-- Main Application Script -->
    <script type="module">
        // ============================================
        // CONFIGURACI√ìN Y CONSTANTES
        // ============================================
        
        const STORAGE_KEY = 'fpunaHorarioData_v5_4';
        const THEME_KEY = 'fpunaTheme';
        const USER_TASKS_KEY = 'fpunaUserTasks';
        const DIAS_SEMANA = ['DOMINGO', 'LUNES', 'MARTES', 'MI√âRCOLES', 'JUEVES', 'VIERNES', 'S√ÅBADO'];
        
        // Palabras clave para detecci√≥n heur√≠stica de encabezados
        const HEADER_KEYWORDS = [
            'ITEM', 'ASIGNATURA', 'NIVEL', 'SEM/GRUPO', 'TURNO', 'SECCI√ìN', 'SECCION',
            'APELLIDO', 'NOMBRE', 'LUNES', 'MARTES', 'MI√âRCOLES', 'MIERCOLES', 
            'JUEVES', 'VIERNES', 'S√ÅBADO', 'SABADO', 'DOMINGO'
        ];
        
        // Sistema de alias mejorado para mapeo flexible de columnas
        const COLUMN_ALIASES = {
            asignatura: ['ASIGNATURA', 'MATERIA'],
            semestre: ['NIVEL', 'SEM/GRUPO', 'SEMESTRE', 'SEM', 'GRUPO'],
            seccion: ['SECCI√ìN', 'SECCION', 'SEC'],
            turno: ['TURNO'],
            enfasis: ['ENFASIS', '√âNFASIS'],
            nombre: ['NOMBRE'],
            apellido: ['APELLIDO']
        };
        
        // ============================================
        // ESTADO DE LA APLICACI√ìN
        // ============================================
        
        const state = {
            workbook: null,
            selectedSheet: null,
            rawData: [],
            fullSchedule: [],      // Horario completo sin filtrar
            fullExamData: [],      // Ex√°menes completos sin filtrar
            fullOccasionalClasses: [], // Clases ocasionales (s√°bados con fechas espec√≠ficas)
            clases: [],            // Datos filtrados
            examenes: [],          // Ex√°menes filtrados
            occasionalClasses: [], // Clases ocasionales filtradas
            selectedSemestres: [],
            selectedAsignaturas: [],
            selectedInstances: [],
            config: {
                carrera: ''
            },
            updateInterval: null,   // Interval para actualizar contadores en tiempo real
            userTasks: []           // Tareas personales del usuario
        };
        
        // ============================================
        // REFERENCIAS DOM
        // ============================================
        
        const dom = {
            // Pantallas
            setupScreen: document.getElementById('setupScreen'),
            dashboardScreen: document.getElementById('dashboardScreen'),
            
            // Setup
            fileInput: document.getElementById('fileInput'),
            fileError: document.getElementById('fileError'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            step4: document.getElementById('step4'),
            carreraSelect: document.getElementById('carreraSelect'),
            semestreCheckboxes: document.getElementById('semestreCheckboxes'),
            asignaturasSection: document.getElementById('asignaturasSection'),
            asignaturaCheckboxes: document.getElementById('asignaturaCheckboxes'),
            instanciasSection: document.getElementById('instanciasSection'),
            instanciaCheckboxes: document.getElementById('instanciaCheckboxes'),
            saveConfigBtn: document.getElementById('saveConfigBtn'),
            
            // Dashboard
            currentDate: document.getElementById('currentDate'),
            todayClasses: document.getElementById('todayClasses'),
            upcomingExams: document.getElementById('upcomingExams'),
            occasionalClasses: document.getElementById('occasionalClasses'),
            settingsBtn: document.getElementById('settingsBtn'),
            
            // Modals
            settingsModal: document.getElementById('settingsModal'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            modifyFiltersBtn: document.getElementById('modifyFiltersBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importInput: document.getElementById('importInput'),
            resetBtn: document.getElementById('resetBtn'),
            confirmModal: document.getElementById('confirmModal'),
            confirmResetBtn: document.getElementById('confirmResetBtn'),
            cancelResetBtn: document.getElementById('cancelResetBtn')
        };
        
        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        
        function showError(message) {
            dom.fileError.textContent = message;
            dom.fileError.classList.remove('hidden');
        }
        
        function hideError() {
            dom.fileError.classList.add('hidden');
        }
        
        function showLoading() {
            dom.loadingSpinner.classList.remove('hidden');
        }
        
        function hideLoading() {
            dom.loadingSpinner.classList.add('hidden');
        }
        
        function normalizeString(str) {
            if (!str) return '';
            return String(str)
                .trim()
                .toUpperCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, ''); // Eliminar acentos
        }
        
        // Detectar la fila de encabezados usando heur√≠stica
        function detectHeaderRow(rawData, maxRowsToCheck = 20) {
            let bestScore = 0;
            let bestRowIndex = -1;
            let bestRow = null;
            
            const rowsToCheck = Math.min(maxRowsToCheck, rawData.length);
            
            for (let i = 0; i < rowsToCheck; i++) {
                const row = rawData[i];
                if (!row || row.length === 0) continue;
                
                let score = 0;
                for (const cell of row) {
                    const cellNormalized = normalizeString(cell);
                    if (HEADER_KEYWORDS.includes(cellNormalized)) {
                        score++;
                    }
                    // Bonus por palabras parciales
                    for (const keyword of HEADER_KEYWORDS) {
                        if (cellNormalized.includes(keyword) && cellNormalized !== keyword) {
                            score += 0.5;
                        }
                    }
                }
                
                if (score > bestScore) {
                    bestScore = score;
                    bestRowIndex = i;
                    bestRow = row;
                }
            }
            
            // Umbral m√≠nimo: al menos 4 coincidencias
            if (bestScore < 4) {
                throw new Error('No se pudo identificar una fila de encabezados v√°lida. Verifica que el archivo tenga el formato correcto.');
            }
            
            console.log(`‚úì Encabezado detectado en fila ${bestRowIndex + 1} (score: ${bestScore})`);
            return { rowIndex: bestRowIndex, headers: bestRow };
        }
        
        // Construir mapa de columnas usando sistema de alias
        function buildColumnMap(headers) {
            const columnMap = {};
            const normalizedHeaders = headers.map((h, idx) => ({
                original: h,
                normalized: normalizeString(h),
                index: idx
            }));
            
            // Mapear cada campo usando sus alias
            for (const [fieldName, aliases] of Object.entries(COLUMN_ALIASES)) {
                let found = false;
                for (const alias of aliases) {
                    const match = normalizedHeaders.find(h => h.normalized === alias);
                    if (match) {
                        columnMap[fieldName] = match.index;
                        found = true;
                        console.log(`  ‚úì ${fieldName}: columna "${match.original}" (√≠ndice ${match.index})`);
                        break;
                    }
                }
                if (!found && (fieldName === 'asignatura' || fieldName === 'semestre')) {
                    throw new Error(`No se pudo encontrar la columna obligatoria: ${fieldName}. Aliases buscados: ${aliases.join(', ')}`);
                }
            }
            
            // Mapear columnas de d√≠as y sus aulas asociadas - NUEVA L√ìGICA ROBUSTA
            columnMap.dias = {};
            columnMap.aulas = {};
            
            // PASO 1: Mapear TODAS las columnas AULA primero
            const aulaColumns = [];
            normalizedHeaders.forEach((h, idx) => {
                if (h.normalized === 'AULA') {
                    aulaColumns.push(idx);
                }
            });
            
            console.log(`  ‚ÑπÔ∏è  Columnas AULA encontradas: ${aulaColumns.length} en √≠ndices [${aulaColumns.join(', ')}]`);
            
            // PASO 2: Para cada d√≠a, encontrar el AULA correspondiente
            DIAS_SEMANA.forEach((dia) => {
                const diaNormalized = normalizeString(dia);
                const diaMatch = normalizedHeaders.find(h => h.normalized === diaNormalized);
                
                if (diaMatch) {
                    columnMap.dias[dia] = diaMatch.index;
                    
                    // Encontrar el aula correspondiente: la columna AULA con el √≠ndice 
                    // m√°s alto que sea MENOR que el √≠ndice del d√≠a
                    const validAulas = aulaColumns.filter(aulaIdx => aulaIdx < diaMatch.index);
                    if (validAulas.length > 0) {
                        const aulaIdx = Math.max(...validAulas);
                        columnMap.aulas[dia] = aulaIdx;
                        console.log(`  ‚úì ${dia}: AULA en √≠ndice ${aulaIdx}`);
                    } else {
                        columnMap.aulas[dia] = null;
                        console.log(`  ‚ö†Ô∏è  ${dia}: No se encontr√≥ AULA asociada`);
                    }
                }
            });
            
            // TAREA #2 v1.1: DETECTAR COLUMNAS DE CLASES OCASIONALES (AS, AT, AU)
            // Buscar el √∫ltimo bloque de tres columnas consecutivas despu√©s de los d√≠as regulares
            // Formato esperado: __EMPTY_44 (AULA), __EMPTY_45 (D√≠a/Fechas), __EMPTY_46 (Hora)
            columnMap.occasionalColumns = null;
            
            // Encontrar el √≠ndice m√°ximo de las columnas de d√≠as regulares
            const maxDayIndex = Object.values(columnMap.dias).reduce((max, idx) => Math.max(max, idx), -1);
            
            console.log(`  üîç Buscando clases ocasionales despu√©s del √≠ndice ${maxDayIndex}...`);
            console.log(`     Total de columnas en Excel: ${normalizedHeaders.length}`);
            
            // Buscar despu√©s de las columnas de d√≠as regulares
            for (let i = maxDayIndex + 1; i < normalizedHeaders.length - 2; i++) {
                const col1 = normalizedHeaders[i];
                const col2 = normalizedHeaders[i + 1];
                const col3 = normalizedHeaders[i + 2];
                
                // Verificar si parecen ser columnas de clases ocasionales
                // Estrategia PERMISIVA: buscar cualquier bloque de 3 columnas __EMPTY consecutivas
                const isEmptyPattern = col1.original.includes('__EMPTY') && 
                                      col2.original.includes('__EMPTY') && 
                                      col3.original.includes('__EMPTY');
                
                const hasAulaPattern = col1.normalized === 'AULA' || col1.original.includes('__EMPTY');
                const hasDayPattern = col2.normalized.includes('DIA') || col2.normalized.includes('FECHA') || 
                                     col2.original.includes('__EMPTY');
                const hasTimePattern = col3.normalized.includes('HORA') || col3.normalized.includes('HORARIO') || 
                                      col3.original.includes('__EMPTY');
                
                if (isEmptyPattern || (hasAulaPattern && hasDayPattern && hasTimePattern)) {
                    columnMap.occasionalColumns = {
                        aula: i,      // Columna AS: Aula
                        fechas: i + 1, // Columna AT: Fechas (ej: "02/08, 20/09, 15/11")
                        hora: i + 2    // Columna AU: Hora
                    };
                    console.log(`  ‚úÖ Columnas de clases ocasionales detectadas:`);
                    console.log(`     AULA: √≠ndice ${i} (${col1.original})`);
                    console.log(`     FECHAS: √≠ndice ${i + 1} (${col2.original})`);
                    console.log(`     HORA: √≠ndice ${i + 2} (${col3.original})`);
                    break; // Usar el primer bloque encontrado
                }
            }
            
            if (!columnMap.occasionalColumns) {
                console.warn(`  ‚ö†Ô∏è  NO se detectaron columnas de clases ocasionales`);
                console.log(`     √öltimas 10 columnas del Excel para debugging:`);
                const lastCols = normalizedHeaders.slice(-10);
                lastCols.forEach((col, idx) => {
                    const realIdx = normalizedHeaders.length - 10 + idx;
                    console.log(`       [${realIdx}] "${col.original}" (normalizado: "${col.normalized}")`);
                });
            }
            
            return columnMap;
        }
        
        // Obtener valor de celda por √≠ndice de columna
        function getCellValue(row, columnIndex) {
            if (columnIndex === undefined || columnIndex === null || columnIndex < 0) return '';
            const value = row[columnIndex];
            return value ? String(value).trim() : '';
        }
        
        function formatDate(dateStr) {
            try {
                // Intentar parsear el formato "Mar 02/09/25" o variantes
                const parts = dateStr.split(' ');
                let datePart = parts.length > 1 ? parts[1] : parts[0];
                
                // Intentar formato DD/MM/YY o DD/MM
                const dateParts = datePart.split('/');
                if (dateParts.length >= 2) {
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const year = dateParts[2] ? (dateParts[2].length === 2 ? 2000 + parseInt(dateParts[2]) : parseInt(dateParts[2])) : new Date().getFullYear();
                    return new Date(year, month, day);
                }
                
                return new Date(dateStr);
            } catch (e) {
                console.error('Error parseando fecha:', dateStr, e);
                return null;
            }
        }
        
        function parseOccasionalDates(text) {
            // TAREA #1 v1.0: Algoritmo ROBUSTO para clases ocasionales (S√°bados)
            // Buscar fechas entre comillas usando expresi√≥n regular: "02/08, 20/09, 15/11"
            const match = text.match(/"([^"]+)"/);
            if (!match) {
                console.log('üìÖ Sin fechas ocasionales en:', text.substring(0, 50));
                return [];
            }
            
            // Extraer el contenido entre comillas, limpiar y dividir por comas
            const datesStr = match[1];
            const dates = datesStr.split(',')
                .map(d => d.trim())
                .filter(d => d && d.length > 0 && d.match(/\d+\/\d+/));
            
            console.log(`‚úÖ Clases ocasionales encontradas: ${dates.length > 0 ? dates.join(', ') : 'ninguna'}`);
            return dates;
        }
        
        function parseTimeRange(timeStr) {
            // Parsear "07:30 - 11:30" => { start: "07:30", end: "11:30" }
            const match = timeStr.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);
            if (!match) return null;
            return { start: match[1], end: match[2] };
        }
        
        function getTimeInMinutes(timeStr) {
            // Convertir "07:30" a minutos desde medianoche
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function getCurrentTimeInMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }
        
        function getTimeDifference(targetTime) {
            const target = getTimeInMinutes(targetTime);
            const current = getCurrentTimeInMinutes();
            return target - current;
        }
        
        function formatTimeDifference(minutes) {
            if (minutes < 0) return null;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours > 0) {
                return `${hours}h ${mins}min`;
            }
            return `${mins}min`;
        }
        
        function getDaysDifference(targetDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(targetDate);
            target.setHours(0, 0, 0, 0);
            
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function getDaysText(days) {
            if (days === 0) return '¬°Es Hoy!';
            if (days === 1) return 'Ma√±ana';
            if (days === -1) return 'Fue ayer';
            if (days < 0) return `Hace ${Math.abs(days)} d√≠as`;
            return `En ${days} d√≠as`;
        }
        
        function getCurrentDayName() {
            const today = new Date();
            return DIAS_SEMANA[today.getDay()];
        }
        
        function formatCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formatted = today.toLocaleDateString('es-ES', options);
            // Capitalizar primera letra
            return 'Hoy es ' + formatted.charAt(0).toUpperCase() + formatted.slice(1);
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return '';
            // Si viene en formato HH:mm:ss, retornar solo HH:mm
            const parts = timeStr.split(':');
            if (parts.length >= 2) {
                return `${parts[0]}:${parts[1]}`;
            }
            return timeStr;
        }
        
        // ============================================
        // CALCULADORA DE NOTA FINAL FPUNA
        // ============================================
        
        function calculateFinalGrade(pp, ef) {
            // Validar inputs
            if (pp < 0 || pp > 100 || ef < 0 || ef > 100) {
                return { error: 'Los valores deben estar entre 0 y 100' };
            }
            
            // Calcular puntuaci√≥n final
            const pf = (0.4 * pp) + (0.6 * ef);
            const pfRedondeado = Math.round(pf);
            
            // Verificar condici√≥n de aprobaci√≥n del examen final
            if (ef < 50) {
                return {
                    pf: pfRedondeado,
                    nota: 1,
                    calificacion: 'Reprobado',
                    reprobadoPorEF: true,
                    mensaje: 'Reprobado por no alcanzar el 50% en el Examen Final'
                };
            }
            
            // Tabla de conversi√≥n seg√∫n reglamento FPUNA
            let nota, calificacion;
            if (pfRedondeado >= 90) {
                nota = 5;
                calificacion = 'Excelente';
            } else if (pfRedondeado >= 80) {
                nota = 4;
                calificacion = 'Muy Bueno';
            } else if (pfRedondeado >= 70) {
                nota = 3;
                calificacion = 'Bueno';
            } else if (pfRedondeado >= 60) {
                nota = 2;
                calificacion = 'Regular';
            } else {
                nota = 1;
                calificacion = 'Reprobado';
            }
            
            return {
                pf: pfRedondeado,
                nota,
                calificacion,
                reprobadoPorEF: false
            };
        }
        
        function openGradeCalculator() {
            const modal = document.getElementById('gradeCalculatorModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('ppInput').value = '';
            document.getElementById('efInput').value = '';
            document.getElementById('gradeResult').innerHTML = '';
        }
        
        function closeGradeCalculator() {
            const modal = document.getElementById('gradeCalculatorModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function performGradeCalculation() {
            const pp = parseFloat(document.getElementById('ppInput').value);
            const ef = parseFloat(document.getElementById('efInput').value);
            const resultDiv = document.getElementById('gradeResult');
            
            if (isNaN(pp) || isNaN(ef)) {
                resultDiv.innerHTML = `
                    <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Por favor ingresa valores v√°lidos en ambos campos
                    </div>
                `;
                return;
            }
            
            const result = calculateFinalGrade(pp, ef);
            
            if (result.error) {
                resultDiv.innerHTML = `
                    <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        ${result.error}
                    </div>
                `;
                return;
            }
            
            const notaColor = result.nota >= 3 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            const bgColor = result.nota >= 3 ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20';
            
            resultDiv.innerHTML = `
                <div class="animate-fade-in ${bgColor} border ${result.nota >= 3 ? 'border-green-400 dark:border-green-600' : 'border-red-400 dark:border-red-600'} rounded-lg p-6 space-y-3">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Puntuaci√≥n Final</div>
                            <div class="text-3xl font-bold ${notaColor}">${result.pf}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Nota</div>
                            <div class="text-3xl font-bold ${notaColor}">${result.nota}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Calificaci√≥n</div>
                            <div class="text-xl font-bold ${notaColor}">${result.calificacion}</div>
                        </div>
                    </div>
                    ${result.reprobadoPorEF ? `
                        <div class="mt-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded text-center font-semibold">
                            <i class="fas fa-times-circle mr-2"></i>
                            ${result.mensaje}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // ============================================
        // GESTOR DE TAREAS PERSONALES
        // ============================================
        
        function loadUserTasks() {
            const tasksJSON = localStorage.getItem(USER_TASKS_KEY);
            if (tasksJSON) {
                try {
                    state.userTasks = JSON.parse(tasksJSON);
                } catch (e) {
                    console.error('Error cargando tareas:', e);
                    state.userTasks = [];
                }
            } else {
                state.userTasks = [];
            }
        }
        
        function saveUserTasks() {
            localStorage.setItem(USER_TASKS_KEY, JSON.stringify(state.userTasks));
        }
        
        function openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            
            if (taskId) {
                // Modo edici√≥n
                const task = state.userTasks.find(t => t.id === taskId);
                if (task) {
                    title.textContent = 'Editar Tarea';
                    document.getElementById('taskTitle').value = task.titulo;
                    document.getElementById('taskDescription').value = task.descripcion || '';
                    document.getElementById('taskDate').value = task.fecha;
                    document.getElementById('taskTime').value = task.hora || '';
                    document.getElementById('taskId').value = taskId;
                }
            } else {
                // Modo crear nueva
                title.textContent = 'Nueva Tarea';
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskDate').value = '';
                document.getElementById('taskTime').value = '';
                document.getElementById('taskId').value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function saveTask() {
            const taskId = document.getElementById('taskId').value;
            const titulo = document.getElementById('taskTitle').value.trim();
            const descripcion = document.getElementById('taskDescription').value.trim();
            const fecha = document.getElementById('taskDate').value;
            const hora = document.getElementById('taskTime').value;
            
            if (!titulo || !fecha) {
                showToast('Por favor completa el t√≠tulo y la fecha', 'error');
                return;
            }
            
            if (taskId) {
                // Actualizar tarea existente
                const taskIndex = state.userTasks.findIndex(t => t.id === taskId);
                if (taskIndex >= 0) {
                    state.userTasks[taskIndex] = {
                        ...state.userTasks[taskIndex],
                        titulo,
                        descripcion,
                        fecha,
                        hora
                    };
                }
            } else {
                // Crear nueva tarea
                const newTask = {
                    id: 'task_' + Date.now(),
                    titulo,
                    descripcion,
                    fecha,
                    hora,
                    completada: false,
                    fechaCreacion: new Date().toISOString()
                };
                state.userTasks.push(newTask);
            }
            
            saveUserTasks();
            closeTaskModal();
            renderUserTasks();
            showToast(taskId ? 'Tarea actualizada' : 'Tarea creada', 'success');
        }
        
        function deleteTask(taskId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
                state.userTasks = state.userTasks.filter(t => t.id !== taskId);
                saveUserTasks();
                renderUserTasks();
                showToast('Tarea eliminada', 'success');
            }
        }
        
        function toggleTaskComplete(taskId) {
            const task = state.userTasks.find(t => t.id === taskId);
            if (task) {
                task.completada = !task.completada;
                if (task.completada) {
                    task.fechaCompletado = new Date().toISOString();
                } else {
                    delete task.fechaCompletado;
                }
                saveUserTasks();
                renderUserTasks();
                showToast(task.completada ? 'Tarea completada ‚úì' : 'Tarea reactivada', 'success');
            }
        }
        
        // TAREA #3 v1.1: Limpieza autom√°tica de tareas antiguas del historial
        function cleanupOldCompletedTasks() {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const beforeCount = state.userTasks.length;
            state.userTasks = state.userTasks.filter(task => {
                if (!task.completada) return true; // Mantener tareas activas
                if (!task.fechaCompletado) return true; // Mantener si no tiene fecha de completado
                
                const completedDate = new Date(task.fechaCompletado);
                return completedDate > sevenDaysAgo; // Mantener si fue completada hace menos de 7 d√≠as
            });
            
            const removedCount = beforeCount - state.userTasks.length;
            if (removedCount > 0) {
                console.log(`üßπ Limpieza autom√°tica: ${removedCount} tareas antiguas eliminadas del historial`);
                saveUserTasks();
            }
        }
        
        function renderUserTasks() {
            const container = document.getElementById('userTasksContainer');
            const historyContainer = document.getElementById('taskHistoryContainer');
            if (!container) return;
            
            // TAREA #3 v1.1: Separar tareas activas de completadas
            const activeTasks = state.userTasks.filter(t => !t.completada);
            const completedTasks = state.userTasks.filter(t => t.completada);
            
            // Ordenar tareas activas por fecha
            const sortedActiveTasks = [...activeTasks].sort((a, b) => {
                return new Date(a.fecha) - new Date(b.fecha);
            });
            
            // Ordenar tareas completadas por fecha de completado (m√°s reciente primero)
            const sortedCompletedTasks = [...completedTasks].sort((a, b) => {
                return new Date(b.fechaCompletado || b.fecha) - new Date(a.fechaCompletado || a.fecha);
            });
            
            // Renderizar tareas activas
            if (sortedActiveTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-clipboard-list text-4xl mb-3 opacity-50"></i>
                        <p>No tienes tareas pendientes</p>
                        <p class="text-sm mt-2">Haz clic en el bot√≥n + para crear una</p>
                    </div>
                `;
            } else {
                container.innerHTML = sortedActiveTasks.map((task, index) => 
                    renderTaskCard(task, index, false)
                ).join('');
            }
            
            // Renderizar historial de tareas completadas
            if (historyContainer) {
                if (sortedCompletedTasks.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-check-circle text-4xl mb-3 opacity-50"></i>
                            <p>No hay tareas completadas en el historial</p>
                        </div>
                    `;
                } else {
                    historyContainer.innerHTML = sortedCompletedTasks.map((task, index) => 
                        renderTaskCard(task, index, true)
                    ).join('');
                }
            }
        }
        
        function renderTaskCard(task, index, isHistory = false) {
            const daysDiff = getDaysDifference(task.fecha);
            const daysText = getDaysText(daysDiff);
            
            const isOverdue = daysDiff < 0 && !task.completada;
            const isToday = daysDiff === 0;
            
            const borderColor = task.completada ? 'border-l-4 border-green-500' : 
                               isOverdue ? 'border-l-4 border-red-500' :
                               isToday ? 'border-l-4 border-orange-500' : 'border-l-4 border-blue-500';
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-3 ${borderColor} animate-fade-in ${task.completada ? 'opacity-75' : ''}" 
                     style="animation-delay: ${index * 0.05}s" data-task-id="${task.id}">
                    <div class="flex items-start gap-3">
                        <button data-action="toggle-complete" data-task-id="${task.id}"
                                class="mt-1 w-6 h-6 flex-shrink-0 rounded-full border-2 flex items-center justify-center transition-all
                                       ${task.completada ? 'bg-green-500 border-green-500' : 'border-gray-400 hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-900'}">
                            ${task.completada ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                        </button>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg ${task.completada ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-800 dark:text-white'}">
                                ${task.titulo}
                            </h3>
                            ${task.descripcion ? `
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${task.descripcion}</p>
                            ` : ''}
                            <div class="flex flex-wrap items-center gap-4 mt-3 text-sm">
                                <span class="flex items-center gap-1 ${isOverdue && !task.completada ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-600 dark:text-gray-400'}">
                                    <i class="far fa-calendar fa-fw"></i>
                                    ${daysText}
                                </span>
                                ${task.hora ? `
                                    <span class="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                                        <i class="far fa-clock fa-fw"></i>
                                        ${task.hora}
                                    </span>
                                ` : ''}
                                ${task.completada && task.fechaCompletado ? `
                                    <span class="flex items-center gap-1 text-green-600 dark:text-green-400 text-xs">
                                        <i class="fas fa-check-circle fa-fw"></i>
                                        Completada ${formatFechaCompletado(task.fechaCompletado)}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            ${!task.completada ? `
                                <button data-action="edit-task" data-task-id="${task.id}"
                                        class="p-2 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900 rounded transition-colors"
                                        title="Editar tarea">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            <button data-action="delete-task" data-task-id="${task.id}"
                                    class="p-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900 rounded transition-colors"
                                    title="Eliminar tarea">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function formatFechaCompletado(fechaISO) {
            const fecha = new Date(fechaISO);
            const ahora = new Date();
            const diffMs = ahora - fecha;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'hace un momento';
            if (diffMins < 60) return `hace ${diffMins} min`;
            if (diffHours < 24) return `hace ${diffHours}h`;
            if (diffDays < 7) return `hace ${diffDays}d`;
            return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
        }
        
        // ============================================
        // SISTEMA DE TEMAS (MODO OSCURO/CLARO)
        // ============================================
        
        function initTheme() {
            // Verificar si hay preferencia guardada
            let savedTheme = localStorage.getItem(THEME_KEY);
            
            if (!savedTheme) {
                // Si no hay preferencia guardada, usar la del sistema
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                savedTheme = prefersDark ? 'dark' : 'light';
                localStorage.setItem(THEME_KEY, savedTheme);
            }
            
            // Aplicar tema
            applyTheme(savedTheme);
        }
        
        function applyTheme(theme) {
            const html = document.documentElement;
            
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            // Actualizar el toggle si existe
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.checked = (theme === 'dark');
            }
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            
            applyTheme(newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
            
            showToast(`Tema ${newTheme === 'dark' ? 'oscuro' : 'claro'} activado`, 'success');
        }
        
        // ============================================
        // SISTEMA DE NOTIFICACIONES (TOAST)
        // ============================================
        
        function showToast(message, type = 'success') {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const iconColor = type === 'success' ? 'text-green-500' : 'text-red-500';
            
            const toast = document.createElement('div');
            toast.className = `toast ${type} ${isDark ? 'dark' : ''}`;
            toast.innerHTML = `
                <i class="fas ${icon} ${iconColor} text-xl"></i>
                <span class="flex-1">${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ============================================
        // PROCESAMIENTO DE DATOS DEL EXCEL
        // ============================================
        
        function processSheetData(sheetName) {
            try {
                console.log(`\nüìä Procesando hoja: "${sheetName}"`);
                const worksheet = state.workbook.Sheets[sheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                console.log(`  Total de filas en Excel: ${rawData.length}`);
                
                // PASO 1: Detectar fila de encabezados din√°micamente
                const { rowIndex: headerRowIndex, headers: headerRow } = detectHeaderRow(rawData);
                
                // PASO 2: Construir mapa de columnas
                console.log(`\nüó∫Ô∏è  Construyendo mapa de columnas...`);
                const columnMap = buildColumnMap(headerRow);
                
                // PASO 3: Procesar filas de datos
                const dataRows = rawData.slice(headerRowIndex + 1);
                console.log(`\nüìã Procesando ${dataRows.length} filas de datos...`);
                
                const processedData = [];
                
                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    
                    // Obtener valores usando el columnMap
                    const asignatura = getCellValue(row, columnMap.asignatura);
                    
                    // Filtrar filas vac√≠as o sin asignatura
                    if (!asignatura || asignatura === '') continue;
                    
                    const dataObj = {
                        asignatura,
                        semestre: getCellValue(row, columnMap.semestre),
                        seccion: getCellValue(row, columnMap.seccion),
                        turno: getCellValue(row, columnMap.turno),
                        enfasis: getCellValue(row, columnMap.enfasis),
                        nombre: getCellValue(row, columnMap.nombre),
                        apellido: getCellValue(row, columnMap.apellido),
                        horarios: {},
                        examenes: []
                    };
                    
                    // Extraer horarios por d√≠a
                    for (const [dia, colIndex] of Object.entries(columnMap.dias)) {
                        const horario = getCellValue(row, colIndex);
                        if (horario) {
                            dataObj.horarios[dia] = horario;
                        }
                    }
                    
                    // TAREA #2: ALGORITMO SIMPLIFICADO DE EXTRACCI√ìN DE EX√ÅMENES
                    // Mapeo directo de tipos de examen a columnas (PapaParse/SheetJS renombra duplicados)
                    const examDateColumns = {
                        '1er. Parcial': 'D√≠a',      // Primera columna D√≠a
                        '2do. Parcial': 'D√≠a_1',    // Segunda columna D√≠a
                        '1er. Final': 'D√≠a_2',      // Tercera columna D√≠a
                        'Revisi√≥n 1er. Final': 'D√≠a_3',  // Cuarta columna D√≠a
                        '2do. Final': 'D√≠a_4',      // Quinta columna D√≠a
                        'Revisi√≥n 2do. Final': 'D√≠a_5'   // Sexta columna D√≠a
                    };
                    
                    // Iterar sobre cada tipo de examen
                    Object.entries(examDateColumns).forEach(([tipo, diaCol]) => {
                        // Buscar el √≠ndice de la columna D√≠a correspondiente
                        const diaIdx = headerRow.findIndex((h, idx) => {
                            const normalized = normalizeString(h);
                            // Determinar qu√© columna D√≠a es esta (contando ocurrencias)
                            let diaCount = 0;
                            for (let i = 0; i <= idx; i++) {
                                if (normalizeString(headerRow[i]).includes('DIA') || 
                                    normalizeString(headerRow[i]).includes('FECHA')) {
                                    if (i < idx) diaCount++;
                                    if (i === idx && (normalized.includes('DIA') || normalized.includes('FECHA'))) {
                                        // Verificar si es la columna D√≠a que buscamos
                                        if (diaCol === 'D√≠a' && diaCount === 0) return true;
                                        if (diaCol === 'D√≠a_1' && diaCount === 1) return true;
                                        if (diaCol === 'D√≠a_2' && diaCount === 2) return true;
                                        if (diaCol === 'D√≠a_3' && diaCount === 3) return true;
                                        if (diaCol === 'D√≠a_4' && diaCount === 4) return true;
                                        if (diaCol === 'D√≠a_5' && diaCount === 5) return true;
                                    }
                                }
                            }
                            return false;
                        });
                        
                        if (diaIdx >= 0) {
                            const fechaValue = getCellValue(row, diaIdx);
                            if (fechaValue && fechaValue.trim() !== '' && 
                                fechaValue !== 'D√≠a' && fechaValue !== 'FECHA' && fechaValue !== 'D√çA') {
                                
                                // La hora y el aula est√°n inmediatamente a la derecha
                                const horaIdx = diaIdx + 1;
                                const aulaIdx = diaIdx + 2;
                                
                                try {
                                    dataObj.examenes.push({
                                        tipo: tipo,
                                        fecha: fechaValue.trim(),
                                        hora: horaIdx < row.length ? getCellValue(row, horaIdx).trim() : '',
                                        aula: aulaIdx < row.length ? getCellValue(row, aulaIdx).trim() : ''
                                    });
                                } catch (e) {
                                    console.warn(`‚ö†Ô∏è  Error procesando examen ${tipo}:`, e);
                                }
                            }
                        }
                    });
                    
                    // TAREA #2 v1.1: EXTRACCI√ìN DE CLASES OCASIONALES DESDE COLUMNAS AS, AT, AU
                    if (columnMap.occasionalColumns) {
                        const aulaOcasional = getCellValue(row, columnMap.occasionalColumns.aula);
                        const fechasStr = getCellValue(row, columnMap.occasionalColumns.fechas);
                        const horaOcasional = getCellValue(row, columnMap.occasionalColumns.hora);
                        
                        // Log de debugging para la primera fila con datos
                        if (i === 0) {
                            console.log(`  üîç Ejemplo de extracci√≥n de clases ocasionales (primera fila):`);
                            console.log(`     Aula: "${aulaOcasional}"`);
                            console.log(`     Fechas: "${fechasStr}"`);
                            console.log(`     Hora: "${horaOcasional}"`);
                        }
                        
                        if (fechasStr && fechasStr.trim() !== '') {
                            // Parsear m√∫ltiples fechas separadas por comas: "02/08, 20/09, 15/11"
                            const fechas = fechasStr.split(',')
                                .map(f => f.trim())
                                .filter(f => f && f.match(/\d+\/\d+/));
                            
                            if (fechas.length > 0) {
                                dataObj.clasesOcasionales = {
                                    aula: aulaOcasional,
                                    fechas: fechas,
                                    hora: horaOcasional
                                };
                                
                                if (i < 3) { // Log solo para las primeras 3 clases ocasionales encontradas
                                    console.log(`  ‚úÖ Clase ocasional encontrada: ${asignatura}`);
                                    console.log(`     Fechas extra√≠das: ${fechas.join(', ')}`);
                                }
                            }
                        }
                    }
                    
                    processedData.push(dataObj);
                }
                
                state.rawData = processedData;
                state.rawDataArray = dataRows; // Guardar array original para acceso por √≠ndice
                state.columnMap = columnMap; // Guardar para referencia
                
                console.log(`‚úÖ Procesamiento exitoso: ${processedData.length} registros v√°lidos\n`);
                return processedData;
                
            } catch (error) {
                console.error('‚ùå Error procesando hoja:', error);
                throw error;
            }
        }
        
        function transformDataToSchedule() {
            console.log('\nüîÑ Transformando datos a estructura de horario...');
            const clases = [];
            const examenes = [];
            const occasionalClasses = [];
            
            state.rawData.forEach(row => {
                const asignatura = row.asignatura;
                const semestre = row.semestre.toUpperCase();
                const seccion = row.seccion.toUpperCase();
                const turno = row.turno.toUpperCase();
                const enfasis = row.enfasis.toUpperCase();
                const profesor = `${row.nombre} ${row.apellido}`.trim();
                
                // Crear ID √∫nico para esta instancia de clase
                const instanceId = `${asignatura}_${semestre}_${seccion}_${turno}_${profesor}`.replace(/\s/g, '_').replace(/[^\w_]/g, '');
                
                // Procesar horarios por d√≠a
                for (const [dia, horario] of Object.entries(row.horarios)) {
                    if (horario && horario.trim() !== '') {
                        // Verificar si es s√°bado con fechas espec√≠ficas
                        if (dia.toUpperCase() === 'S√ÅBADO' || dia.toUpperCase() === 'SABADO') {
                            const fechas = parseOccasionalDates(horario);
                            
                            if (fechas.length > 0) {
                                // Es una clase ocasional con fechas espec√≠ficas
                                const timeRange = parseTimeRange(horario);
                                // CORREGIDO: Regex para aula (sin barra invertida doble)
                                const aulaMatch = horario.match(/F(\d+)/);
                                const aula = aulaMatch ? `F${aulaMatch[1]}` : '';
                                
                                fechas.forEach(fechaStr => {
                                    occasionalClasses.push({
                                        instanceId,
                                        asignatura,
                                        semestre,
                                        seccion,
                                        turno,
                                        enfasis,
                                        profesor,
                                        fecha: fechaStr,
                                        hora: timeRange ? `${timeRange.start} - ${timeRange.end}` : '',
                                        horaInicio: timeRange ? timeRange.start : '',
                                        horaFin: timeRange ? timeRange.end : '',
                                        aula: aula,
                                        horarioCompleto: horario.trim()
                                    });
                                });
                                continue; // No agregar como clase regular
                            }
                        }
                        
                        // Clase regular (incluyendo s√°bados sin fechas espec√≠ficas)
                        let aula = '';
                        if (state.columnMap && state.columnMap.aulas && state.columnMap.aulas[dia] !== null) {
                            const rowIndex = state.rawData.indexOf(row);
                            if (rowIndex >= 0 && state.rawDataArray && state.rawDataArray[rowIndex]) {
                                aula = getCellValue(state.rawDataArray[rowIndex], state.columnMap.aulas[dia]) || '';
                            }
                        }
                        
                        clases.push({
                            instanceId,
                            asignatura,
                            semestre,
                            seccion,
                            turno,
                            enfasis,
                            profesor,
                            dia: dia.toUpperCase(),
                            hora: horario.trim(),
                            aula: aula
                        });
                    }
                }
                
                // TAREA #2 v1.1: Procesar clases ocasionales desde las columnas AS, AT, AU
                if (row.clasesOcasionales && row.clasesOcasionales.fechas) {
                    const { aula, fechas, hora } = row.clasesOcasionales;
                    const timeRange = parseTimeRange(hora);
                    
                    console.log(`  üìÖ Procesando clases ocasionales para: ${asignatura}`);
                    console.log(`     Fechas a procesar: ${fechas.join(', ')}`);
                    
                    fechas.forEach(fechaStr => {
                        occasionalClasses.push({
                            instanceId,
                            asignatura,
                            semestre,
                            seccion,
                            turno,
                            enfasis,
                            profesor,
                            fecha: fechaStr,
                            hora: hora,
                            horaInicio: timeRange ? timeRange.start : '',
                            horaFin: timeRange ? timeRange.end : '',
                            aula: aula || '',
                            horarioCompleto: `${hora} ${aula}`.trim()
                        });
                    });
                }
                
                // Procesar ex√°menes (el tipo ya viene normalizado de processSheetData)
                row.examenes.forEach(examen => {
                    if (examen.fecha && examen.fecha.trim() !== '') {
                        examenes.push({
                            instanceId,
                            asignatura,
                            semestre,
                            seccion,
                            turno,
                            enfasis,
                            tipo: examen.tipo,
                            fecha: examen.fecha.trim(),
                            hora: examen.hora.trim(),
                            aula: examen.aula.trim()
                        });
                    }
                });
            });
            
            state.fullSchedule = clases;
            state.fullExamData = examenes;
            state.fullOccasionalClasses = occasionalClasses;
            console.log(`‚úÖ Transformaci√≥n completa: ${clases.length} clases, ${examenes.length} ex√°menes, ${occasionalClasses.length} clases ocasionales\n`);
        }
        
        // ============================================
        // FUNCIONES PARA FILTROS EN CASCADA
        // ============================================
        
        function getUniqueSemestres() {
            const semestres = new Set();
            state.fullSchedule.forEach(clase => {
                if (clase.semestre) semestres.add(clase.semestre);
            });
            return Array.from(semestres).sort();
        }
        
        function getAsignaturasBySemestres(semestres) {
            const asignaturas = new Set();
            state.fullSchedule.forEach(clase => {
                if (semestres.includes(clase.semestre)) {
                    asignaturas.add(clase.asignatura);
                }
            });
            return Array.from(asignaturas).sort();
        }
        
        function getInstancesByAsignaturas(asignaturas) {
            const instancesMap = new Map();
            
            state.fullSchedule.forEach(clase => {
                if (asignaturas.includes(clase.asignatura)) {
                    if (!instancesMap.has(clase.instanceId)) {
                        instancesMap.set(clase.instanceId, {
                            instanceId: clase.instanceId,
                            asignatura: clase.asignatura,
                            semestre: clase.semestre,
                            seccion: clase.seccion,
                            turno: clase.turno,
                            profesor: clase.profesor
                        });
                    }
                }
            });
            
            return Array.from(instancesMap.values()).sort((a, b) => {
                // Ordenar por asignatura primero, luego por secci√≥n
                if (a.asignatura !== b.asignatura) {
                    return a.asignatura.localeCompare(b.asignatura);
                }
                return a.seccion.localeCompare(b.seccion);
            });
        }
        
        function populateSemestres() {
            const semestres = getUniqueSemestres();
            const container = dom.semestreCheckboxes;
            container.innerHTML = '';
            
            if (semestres.length === 0) {
                container.innerHTML = '<p class="text-red-500">No se encontraron semestres en los datos</p>';
                return;
            }
            
            // Checkbox "Seleccionar Todos"
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'flex items-center p-2 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800';
            selectAllDiv.innerHTML = `
                <input type="checkbox" id="selectAllSemestres" 
                    class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-2 cursor-pointer">
                <label for="selectAllSemestres" class="text-sm font-semibold cursor-pointer flex-1">
                    Seleccionar Todos
                </label>
            `;
            container.appendChild(selectAllDiv);
            
            // Checkboxes individuales
            semestres.forEach(sem => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 bg-gray-50 dark:bg-gray-700 rounded';
                div.innerHTML = `
                    <input type="checkbox" id="sem_${sem}" value="${sem}"
                        class="semestreCheckbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-2 cursor-pointer">
                    <label for="sem_${sem}" class="text-sm cursor-pointer flex-1">
                        Semestre ${sem}
                    </label>
                `;
                container.appendChild(div);
            });
            
            // Event listeners
            const selectAll = document.getElementById('selectAllSemestres');
            const checkboxes = document.querySelectorAll('.semestreCheckbox');
            
            selectAll.addEventListener('change', (e) => {
                checkboxes.forEach(cb => cb.checked = e.target.checked);
                onSemestreChange();
            });
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                    selectAll.checked = allChecked;
                    onSemestreChange();
                });
            });
        }
        
        function onSemestreChange() {
            const selected = Array.from(document.querySelectorAll('.semestreCheckbox:checked')).map(cb => cb.value);
            state.selectedSemestres = selected;
            
            if (selected.length > 0) {
                populateAsignaturas(selected);
                dom.asignaturasSection.classList.remove('hidden');
            } else {
                dom.asignaturasSection.classList.add('hidden');
                dom.instanciasSection.classList.add('hidden');
                dom.step4.classList.add('hidden');
            }
        }
        
        function populateAsignaturas(semestres) {
            const asignaturas = getAsignaturasBySemestres(semestres);
            const container = dom.asignaturaCheckboxes;
            container.innerHTML = '';
            
            // Checkbox "Seleccionar Todos"
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'col-span-full flex items-center p-2 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-800';
            selectAllDiv.innerHTML = `
                <input type="checkbox" id="selectAllAsignaturas" 
                    class="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-500 mr-2 cursor-pointer">
                <label for="selectAllAsignaturas" class="text-sm font-semibold cursor-pointer flex-1">
                    Seleccionar Todas
                </label>
            `;
            container.appendChild(selectAllDiv);
            
            // Checkboxes individuales
            asignaturas.forEach(asig => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 bg-gray-50 dark:bg-gray-700 rounded';
                const safeId = asig.replace(/\s/g, '_').replace(/[^\w-]/g, '');
                div.innerHTML = `
                    <input type="checkbox" id="asig_${safeId}" value="${asig}"
                        class="asignaturaCheckbox w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-500 mr-2 cursor-pointer">
                    <label for="asig_${safeId}" class="text-sm cursor-pointer flex-1">
                        ${asig}
                    </label>
                `;
                container.appendChild(div);
            });
            
            // Event listeners
            const selectAll = document.getElementById('selectAllAsignaturas');
            const checkboxes = document.querySelectorAll('.asignaturaCheckbox');
            
            selectAll.addEventListener('change', (e) => {
                checkboxes.forEach(cb => cb.checked = e.target.checked);
                onAsignaturaChange();
            });
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                    selectAll.checked = allChecked;
                    onAsignaturaChange();
                });
            });
            
            // Reset selecci√≥n de instancias
            state.selectedAsignaturas = [];
            state.selectedInstances = [];
        }
        
        function onAsignaturaChange() {
            const selected = Array.from(document.querySelectorAll('.asignaturaCheckbox:checked')).map(cb => cb.value);
            state.selectedAsignaturas = selected;
            
            if (selected.length > 0) {
                const instances = getInstancesByAsignaturas(selected);
                
                // Si todas las asignaturas tienen solo una instancia, saltar el paso 3.3
                const multipleInstances = selected.some(asig => {
                    const count = instances.filter(inst => inst.asignatura === asig).length;
                    return count > 1;
                });
                
                if (multipleInstances) {
                    populateInstances(instances);
                    dom.instanciasSection.classList.remove('hidden');
                    dom.step4.classList.add('hidden');
                } else {
                    // Auto-seleccionar las √∫nicas instancias disponibles
                    state.selectedInstances = instances.map(inst => inst.instanceId);
                    dom.instanciasSection.classList.add('hidden');
                    dom.step4.classList.remove('hidden');
                }
            } else {
                dom.instanciasSection.classList.add('hidden');
                dom.step4.classList.add('hidden');
            }
        }
        
        function populateInstances(instances) {
            const container = dom.instanciaCheckboxes;
            container.innerHTML = '';
            
            // Agrupar por asignatura
            const grouped = {};
            instances.forEach(inst => {
                if (!grouped[inst.asignatura]) {
                    grouped[inst.asignatura] = [];
                }
                grouped[inst.asignatura].push(inst);
            });
            
            // Renderizar por grupo
            Object.keys(grouped).sort().forEach(asignatura => {
                const group = grouped[asignatura];
                
                if (group.length === 1) {
                    // Si solo hay una instancia, marcarla autom√°ticamente
                    const inst = group[0];
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600';
                    div.innerHTML = `
                        <input type="checkbox" id="inst_${inst.instanceId}" value="${inst.instanceId}"
                            class="instanciaCheckbox w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 mr-3 cursor-pointer"
                            checked>
                        <label for="inst_${inst.instanceId}" class="text-sm cursor-pointer flex-1">
                            <span class="font-semibold">${inst.asignatura}</span><br>
                            <span class="text-xs text-gray-600 dark:text-gray-400">
                                Secci√≥n: ${inst.seccion} | Turno: ${inst.turno} | ${inst.profesor}
                            </span>
                        </label>
                    `;
                    container.appendChild(div);
                } else {
                    // M√∫ltiples instancias, mostrar con encabezado
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'font-semibold text-sm text-purple-700 dark:text-purple-300 mt-3 mb-2 pb-2 border-b border-purple-200 dark:border-purple-800';
                    headerDiv.textContent = asignatura;
                    container.appendChild(headerDiv);
                    
                    group.forEach(inst => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center p-3 ml-4 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600 mb-2';
                        div.innerHTML = `
                            <input type="checkbox" id="inst_${inst.instanceId}" value="${inst.instanceId}"
                                class="instanciaCheckbox w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 mr-3 cursor-pointer">
                            <label for="inst_${inst.instanceId}" class="text-sm cursor-pointer flex-1">
                                <span class="text-xs text-gray-600 dark:text-gray-400">
                                    Secci√≥n: <strong>${inst.seccion}</strong> | Turno: <strong>${inst.turno}</strong> | ${inst.profesor}
                                </span>
                            </label>
                        `;
                        container.appendChild(div);
                    });
                }
            });
            
            // Event listeners
            const checkboxes = document.querySelectorAll('.instanciaCheckbox');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', onInstanceChange);
            });
            
            // Trigger inicial
            onInstanceChange();
        }
        
        function onInstanceChange() {
            const selected = Array.from(document.querySelectorAll('.instanciaCheckbox:checked')).map(cb => cb.value);
            state.selectedInstances = selected;
            
            if (selected.length > 0) {
                dom.step4.classList.remove('hidden');
            } else {
                dom.step4.classList.add('hidden');
            }
        }
        
        function applyFilters() {
            // Filtrar clases bas√°ndose en las instancias seleccionadas
            state.clases = state.fullSchedule.filter(clase => 
                state.selectedInstances.includes(clase.instanceId)
            );
            
            // Filtrar ex√°menes bas√°ndose en las instancias seleccionadas
            state.examenes = state.fullExamData.filter(examen => 
                state.selectedInstances.includes(examen.instanceId)
            );
            
            // Filtrar clases ocasionales bas√°ndose en las instancias seleccionadas
            state.occasionalClasses = state.fullOccasionalClasses.filter(clase => 
                state.selectedInstances.includes(clase.instanceId)
            );
            
            console.log(`Filtrado aplicado: ${state.clases.length} clases, ${state.examenes.length} ex√°menes, ${state.occasionalClasses.length} clases ocasionales`);
        }
        
        // ============================================
        // RENDERIZADO DEL DASHBOARD
        // ============================================
        
        // TAREA #3 v1.0: FUNCI√ìN UNIFICADA PARA CREAR TARJETAS DE EVENTOS
        function createEventCard(event) {
            const { tipo, titulo, subtitulo, fecha, hora, aula, profesor, contador, borderColor, badgeText, badgeColor, index = 0 } = event;
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border-l-4 ${borderColor} animate-fade-in hover:shadow-lg transition-shadow" style="animation-delay: ${index * 0.1}s">
                    <!-- CABECERA -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-white">${titulo}</h3>
                            ${subtitulo ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${subtitulo}</p>` : ''}
                        </div>
                        <span class="ml-3 ${badgeColor} rounded-full px-3 py-1 text-xs font-semibold whitespace-nowrap">
                            ${badgeText}
                        </span>
                    </div>
                    
                    <!-- CUERPO: GRID 2x2 CON ICONOS -->
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-3 text-sm">
                        ${fecha ? `
                        <div class="flex items-center text-gray-600 dark:text-gray-400">
                            <i class="fa-solid fa-calendar-day fa-fw mr-2 text-gray-400"></i>
                            <span>${fecha}</span>
                        </div>
                        ` : ''}
                        
                        ${aula ? `
                        <div class="flex items-center text-gray-600 dark:text-gray-400">
                            <i class="fa-solid fa-school fa-fw mr-2 text-gray-400"></i>
                            <span>${aula}</span>
                        </div>
                        ` : ''}
                        
                        ${hora ? `
                        <div class="flex items-center text-gray-600 dark:text-gray-400">
                            <i class="fa-solid fa-clock fa-fw mr-2 text-gray-400"></i>
                            <span>${hora}</span>
                        </div>
                        ` : ''}
                        
                        ${profesor ? `
                        <div class="flex items-center text-gray-600 dark:text-gray-400">
                            <i class="fa-solid fa-chalkboard-user fa-fw mr-2 text-gray-400"></i>
                            <span>${profesor}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- PIE: CONTADOR -->
                    ${contador ? `
                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center ${contador.colorClass}">
                            <i class="${contador.icon} fa-fw mr-2"></i>
                            <span class="font-semibold ${contador.animate ? 'animate-pulse' : ''}">${contador.text}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function renderTodayClasses() {
            const currentDay = getCurrentDayName();
            const currentTime = getCurrentTimeInMinutes();
            
            const todayClasses = state.clases
                .filter(clase => clase.dia === currentDay)
                .sort((a, b) => {
                    const horaA = a.hora.split('-')[0].trim();
                    const horaB = b.hora.split('-')[0].trim();
                    return horaA.localeCompare(horaB);
                });
            
            if (todayClasses.length === 0) {
                dom.todayClasses.innerHTML = `
                    <div class="card text-center py-8 animate-fade-in">
                        <i class="fas fa-coffee text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400">No tienes clases hoy. ¬°Disfruta tu d√≠a libre!</p>
                    </div>
                `;
                return;
            }
            
            dom.todayClasses.innerHTML = todayClasses.map((clase, index) => {
                const timeRange = parseTimeRange(clase.hora);
                let contador = null;
                let borderColor = 'border-blue-500';
                
                if (timeRange) {
                    const startTime = getTimeInMinutes(timeRange.start);
                    const endTime = getTimeInMinutes(timeRange.end);
                    
                    if (currentTime < startTime) {
                        // Clase futura
                        const diff = startTime - currentTime;
                        const formatted = formatTimeDifference(diff);
                        contador = {
                            text: `Empieza en ${formatted}`,
                            icon: 'fa-solid fa-hourglass-start',
                            colorClass: 'text-green-600 dark:text-green-400',
                            animate: false
                        };
                        borderColor = 'border-green-500';
                    } else if (currentTime >= startTime && currentTime <= endTime) {
                        // Clase en curso
                        const diff = endTime - currentTime;
                        const formatted = formatTimeDifference(diff);
                        contador = {
                            text: `En curso, termina en ${formatted}`,
                            icon: 'fa-solid fa-hourglass-half',
                            colorClass: 'text-orange-600 dark:text-orange-400',
                            animate: true
                        };
                        borderColor = 'border-orange-500';
                    } else {
                        // Clase finalizada
                        contador = {
                            text: 'Finalizada',
                            icon: 'fa-solid fa-check',
                            colorClass: 'text-gray-500 dark:text-gray-500',
                            animate: false
                        };
                        borderColor = 'border-gray-400';
                    }
                }
                
                return createEventCard({
                    tipo: 'clase',
                    titulo: clase.asignatura,
                    subtitulo: `${clase.seccion} - ${clase.turno}`,
                    fecha: `Hoy, ${currentDay}`,
                    hora: clase.hora,
                    aula: clase.aula || 'Por confirmar',
                    profesor: clase.profesor,
                    contador: contador,
                    borderColor: borderColor,
                    badgeText: 'Clase de Hoy',
                    badgeColor: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    index: index
                });
            }).join('');
        }
        
        function renderUpcomingExams() {
            const now = new Date();
            
            const upcomingExams = state.examenes
                .map(examen => {
                    const fecha = formatDate(examen.fecha);
                    return {
                        ...examen,
                        fechaObj: fecha,
                        daysLeft: fecha ? getDaysDifference(fecha) : null
                    };
                })
                .filter(examen => examen.fechaObj && examen.daysLeft !== null && examen.daysLeft >= -1)
                .sort((a, b) => a.daysLeft - b.daysLeft)
                .slice(0, 10);
            
            if (upcomingExams.length === 0) {
                dom.upcomingExams.innerHTML = `
                    <div class="card text-center py-8">
                        <i class="fas fa-check-circle text-4xl text-green-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400">No hay ex√°menes pr√≥ximos registrados.</p>
                    </div>
                `;
                return;
            }
            
            dom.upcomingExams.innerHTML = upcomingExams.map((examen, index) => {
                const isParcial = examen.tipo.toLowerCase().includes('parcial');
                const isFinal = examen.tipo.toLowerCase().includes('final');
                const isRevision = examen.tipo.toLowerCase().includes('revision') || examen.tipo.toLowerCase().includes('revisi√≥n');
                
                const borderColor = isParcial ? 'border-red-600' :
                                   isFinal ? 'border-purple-600' :
                                   'border-yellow-600';
                
                const badgeColor = isParcial ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                                  isFinal ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' :
                                  'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                
                const daysText = getDaysText(examen.daysLeft);
                const isToday = examen.daysLeft === 0;
                const isTomorrow = examen.daysLeft === 1;
                const horaFormateada = formatTime(examen.hora);
                
                const contador = {
                    text: daysText,
                    icon: isToday ? 'fa-solid fa-exclamation-triangle' : 
                          isTomorrow ? 'fa-solid fa-bell' : 
                          'fa-solid fa-calendar-check',
                    colorClass: isToday ? 'text-red-600 dark:text-red-400' :
                               isTomorrow ? 'text-orange-600 dark:text-orange-400' :
                               'text-blue-600 dark:text-blue-400',
                    animate: isToday
                };
                
                return createEventCard({
                    tipo: 'examen',
                    titulo: examen.asignatura,
                    subtitulo: `${examen.seccion || ''} ${examen.turno || ''}`.trim(),
                    fecha: examen.fecha,
                    hora: horaFormateada,
                    aula: examen.aula || 'Por confirmar',
                    profesor: null,
                    contador: contador,
                    borderColor: borderColor,
                    badgeText: examen.tipo,
                    badgeColor: badgeColor,
                    index: index
                });
            }).join('');
        }
        
        function renderOccasionalClasses() {
            const upcomingClasses = state.occasionalClasses
                .map(clase => {
                    const fecha = formatDate(clase.fecha);
                    return {
                        ...clase,
                        fechaObj: fecha,
                        daysLeft: fecha ? getDaysDifference(fecha) : null
                    };
                })
                .filter(clase => clase.fechaObj && clase.daysLeft !== null && clase.daysLeft >= -1)
                .sort((a, b) => a.daysLeft - b.daysLeft)
                .slice(0, 10);
            
            if (upcomingClasses.length === 0) {
                dom.occasionalClasses.innerHTML = `
                    <div class="card text-center py-8 animate-fade-in">
                        <i class="fas fa-calendar-day text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400">No hay clases ocasionales pr√≥ximas.</p>
                    </div>
                `;
                return;
            }
            
            dom.occasionalClasses.innerHTML = upcomingClasses.map((clase, index) => {
                const daysText = getDaysText(clase.daysLeft);
                const isToday = clase.daysLeft === 0;
                const isTomorrow = clase.daysLeft === 1;
                const horaFormateada = formatTime(clase.horaInicio);
                
                const contador = {
                    text: daysText,
                    icon: isToday ? 'fa-solid fa-star' : 'fa-solid fa-calendar-day',
                    colorClass: isToday ? 'text-green-600 dark:text-green-400' :
                               isTomorrow ? 'text-orange-600 dark:text-orange-400' :
                               'text-blue-600 dark:text-blue-400',
                    animate: isToday
                };
                
                return createEventCard({
                    tipo: 'ocasional',
                    titulo: clase.asignatura,
                    subtitulo: `Clase Ocasional - S√°bado`,
                    fecha: clase.fecha,
                    hora: clase.hora || horaFormateada,
                    aula: clase.aula || 'Por confirmar',
                    profesor: clase.profesor,
                    contador: contador,
                    borderColor: 'border-indigo-600',
                    badgeText: 'Clase Ocasional',
                    badgeColor: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200',
                    index: index
                });
            }).join('');
        }
        
        function renderDashboard() {
            dom.currentDate.textContent = formatCurrentDate();
            renderTodayClasses();
            renderUpcomingExams();
            renderOccasionalClasses();
            renderUserTasks();
            
            // Iniciar actualizaci√≥n autom√°tica cada minuto
            if (state.updateInterval) {
                clearInterval(state.updateInterval);
            }
            state.updateInterval = setInterval(() => {
                renderTodayClasses();
            }, 60000); // Actualizar cada minuto
        }
        
        // ============================================
        // GESTI√ìN DE ALMACENAMIENTO
        // ============================================
        
        function saveToLocalStorage() {
            const data = {
                config: state.config,
                selectedSemestres: state.selectedSemestres,
                selectedAsignaturas: state.selectedAsignaturas,
                selectedInstances: state.selectedInstances,
                clases: state.clases,
                examenes: state.examenes,
                occasionalClasses: state.occasionalClasses,
                fullSchedule: state.fullSchedule,
                fullExamData: state.fullExamData,
                fullOccasionalClasses: state.fullOccasionalClasses,
                rawData: state.rawData,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    state.config = parsed.config;
                    state.selectedSemestres = parsed.selectedSemestres || [];
                    state.selectedAsignaturas = parsed.selectedAsignaturas || [];
                    state.selectedInstances = parsed.selectedInstances || [];
                    state.clases = parsed.clases;
                    state.examenes = parsed.examenes;
                    state.occasionalClasses = parsed.occasionalClasses || [];
                    state.fullSchedule = parsed.fullSchedule || [];
                    state.fullExamData = parsed.fullExamData || [];
                    state.fullOccasionalClasses = parsed.fullOccasionalClasses || [];
                    state.rawData = parsed.rawData || [];
                    return true;
                } catch (e) {
                    console.error('Error cargando datos del localStorage:', e);
                    return false;
                }
            }
            return false;
        }
        
        function exportToJSON() {
            const data = {
                config: state.config,
                selectedSemestres: state.selectedSemestres,
                selectedAsignaturas: state.selectedAsignaturas,
                selectedInstances: state.selectedInstances,
                clases: state.clases,
                examenes: state.examenes,
                occasionalClasses: state.occasionalClasses,
                fullSchedule: state.fullSchedule,
                fullExamData: state.fullExamData,
                fullOccasionalClasses: state.fullOccasionalClasses,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mi_horario_fpuna.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Horario exportado correctamente', 'success');
        }
        
        function importFromJSON(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state.config = data.config;
                    state.selectedSemestres = data.selectedSemestres || [];
                    state.selectedAsignaturas = data.selectedAsignaturas || [];
                    state.selectedInstances = data.selectedInstances || [];
                    state.clases = data.clases;
                    state.examenes = data.examenes;
                    state.occasionalClasses = data.occasionalClasses || [];
                    state.fullSchedule = data.fullSchedule || [];
                    state.fullExamData = data.fullExamData || [];
                    state.fullOccasionalClasses = data.fullOccasionalClasses || [];
                    saveToLocalStorage();
                    showDashboard();
                    showToast('Datos importados correctamente', 'success');
                } catch (error) {
                    showToast('Error al importar el archivo JSON', 'error');
                    console.error('Error:', error);
                }
            };
            reader.readAsText(file);
        }
        
        function handleReset() {
            dom.confirmModal.classList.remove('hidden');
            dom.confirmModal.classList.add('flex');
        }
        
        function confirmReset() {
            localStorage.removeItem(STORAGE_KEY);
            showToast('Aplicaci√≥n reiniciada correctamente', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        // ============================================
        // NAVEGACI√ìN
        // ============================================
        
        function showSetup(goDirectlyToFilters = false) {
            dom.setupScreen.classList.remove('hidden');
            dom.dashboardScreen.classList.add('hidden');
            
            if (goDirectlyToFilters && state.fullSchedule.length > 0) {
                // Mostrar solo los pasos relevantes para modificar filtros
                dom.step1.classList.add('hidden');
                dom.step2.classList.add('hidden');
                dom.step3.classList.remove('hidden');
                
                // Recrear los filtros
                populateSemestres();
                
                // Restaurar selecciones previas si existen
                if (state.selectedSemestres.length > 0) {
                    setTimeout(() => {
                        state.selectedSemestres.forEach(sem => {
                            const checkbox = document.getElementById(`sem_${sem}`);
                            if (checkbox) checkbox.checked = true;
                        });
                        onSemestreChange();
                        
                        // Restaurar asignaturas
                        if (state.selectedAsignaturas.length > 0) {
                            setTimeout(() => {
                                state.selectedAsignaturas.forEach(asig => {
                                    const safeId = asig.replace(/\s/g, '_').replace(/[^\w-]/g, '');
                                    const checkbox = document.getElementById(`asig_${safeId}`);
                                    if (checkbox) checkbox.checked = true;
                                });
                                onAsignaturaChange();
                                
                                // Restaurar instancias
                                if (state.selectedInstances.length > 0) {
                                    setTimeout(() => {
                                        state.selectedInstances.forEach(instId => {
                                            const checkbox = document.getElementById(`inst_${instId}`);
                                            if (checkbox) checkbox.checked = true;
                                        });
                                        onInstanceChange();
                                    }, 100);
                                }
                            }, 100);
                        }
                    }, 100);
                }
            }
        }
        
        function showDashboard() {
            dom.setupScreen.classList.add('hidden');
            dom.dashboardScreen.classList.remove('hidden');
            renderDashboard();
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        dom.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            hideError();
            showLoading();
            
            try {
                const data = await file.arrayBuffer();
                state.workbook = XLSX.read(data, { type: 'array' });
                
                // Poblar select de carreras
                dom.carreraSelect.innerHTML = '<option value="">-- Selecciona una carrera --</option>';
                state.workbook.SheetNames.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    dom.carreraSelect.appendChild(option);
                });
                
                // Mostrar siguiente paso
                dom.step2.classList.remove('hidden');
                hideLoading();
                
            } catch (error) {
                hideLoading();
                showError('Error al cargar el archivo. Aseg√∫rate de que sea un archivo Excel v√°lido.');
                console.error('Error:', error);
            }
        });
        
        dom.carreraSelect.addEventListener('change', (e) => {
            const sheetName = e.target.value;
            if (!sheetName) return;
            
            showLoading();
            
            try {
                state.config.carrera = sheetName;
                processSheetData(sheetName);
                transformDataToSchedule();
                
                // Mostrar paso 3 y poblar semestres
                populateSemestres();
                dom.step3.classList.remove('hidden');
                
                hideLoading();
                showToast('Carrera cargada correctamente', 'success');
                
            } catch (error) {
                hideLoading();
                showError('Error al procesar la hoja seleccionada: ' + error.message);
                console.error('Error:', error);
            }
        });
        
        dom.saveConfigBtn.addEventListener('click', () => {
            showLoading();
            
            try {
                // Aplicar filtros basados en las selecciones
                applyFilters();
                
                // Guardar en localStorage
                saveToLocalStorage();
                
                hideLoading();
                showDashboard();
                showToast(`Horario generado: ${state.clases.length} clases encontradas`, 'success');
                
            } catch (error) {
                hideLoading();
                showError('Error al generar el horario.');
                console.error('Error:', error);
            }
        });
        
        if (dom.settingsBtn) {
            dom.settingsBtn.addEventListener('click', () => {
                if (dom.settingsModal) {
                    dom.settingsModal.classList.remove('hidden');
                    dom.settingsModal.classList.add('flex');
                }
                // Asegurar que el toggle refleje el estado actual
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    const isDark = document.documentElement.classList.contains('dark');
                    themeToggle.checked = isDark;
                }
            });
        }
        
        // Event listener para el toggle de tema (delegado porque el elemento se crea despu√©s)
        document.addEventListener('change', (e) => {
            if (e.target && e.target.id === 'themeToggle') {
                toggleTheme();
            }
        });
        
        if (dom.closeSettingsBtn) {
            dom.closeSettingsBtn.addEventListener('click', () => {
                if (dom.settingsModal) {
                    dom.settingsModal.classList.add('hidden');
                    dom.settingsModal.classList.remove('flex');
                }
            });
        }
        
        if (dom.settingsModal) {
            dom.settingsModal.addEventListener('click', (e) => {
                if (e.target === dom.settingsModal) {
                    dom.settingsModal.classList.add('hidden');
                    dom.settingsModal.classList.remove('flex');
                }
            });
        }
        
        if (dom.modifyFiltersBtn) {
            dom.modifyFiltersBtn.addEventListener('click', () => {
                if (dom.settingsModal) {
                    dom.settingsModal.classList.add('hidden');
                    dom.settingsModal.classList.remove('flex');
                }
                showSetup(true);
            });
        }
        
        if (dom.exportBtn) {
            dom.exportBtn.addEventListener('click', () => {
                exportToJSON();
            });
        }
        
        if (dom.importInput) {
            dom.importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importFromJSON(file);
                    if (dom.settingsModal) {
                        dom.settingsModal.classList.add('hidden');
                        dom.settingsModal.classList.remove('flex');
                    }
                }
            });
        }
        
        if (dom.resetBtn) {
            dom.resetBtn.addEventListener('click', () => {
                handleReset();
            });
        }
        
        if (dom.confirmResetBtn) {
            dom.confirmResetBtn.addEventListener('click', () => {
                confirmReset();
            });
        }
        
        if (dom.cancelResetBtn) {
            dom.cancelResetBtn.addEventListener('click', () => {
                if (dom.confirmModal) {
                    dom.confirmModal.classList.add('hidden');
                    dom.confirmModal.classList.remove('flex');
                }
            });
        }
        
        if (dom.confirmModal) {
            dom.confirmModal.addEventListener('click', (e) => {
                if (e.target === dom.confirmModal) {
                    dom.confirmModal.classList.add('hidden');
                    dom.confirmModal.classList.remove('flex');
                }
            });
        }
        
        // ============================================
        // EVENT LISTENERS - TODA LA INTERACTIVIDAD
        // ============================================
        
        // Esperar a que el DOM est√© listo antes de asignar event listeners
        document.addEventListener('DOMContentLoaded', function() {
            
            // ===== MODALES =====
            
            // TAREA #2 v1.0: CALCULADORA Y TAREAS COMPLETAMENTE ACTIVADAS
            
            // Calculadora de Notas
            const gradeCalculatorBtn = document.getElementById('gradeCalculatorBtn');
            const gradeCalculatorModal = document.getElementById('gradeCalculatorModal');
            const closeGradeCalculatorBtn = document.getElementById('closeGradeCalculatorBtn');
            const calculateGradeBtn = document.getElementById('calculateGradeBtn');
            
            if (gradeCalculatorBtn) {
                gradeCalculatorBtn.addEventListener('click', openGradeCalculator);
            }
            
            if (closeGradeCalculatorBtn) {
                closeGradeCalculatorBtn.addEventListener('click', closeGradeCalculator);
            }
            
            if (calculateGradeBtn) {
                calculateGradeBtn.addEventListener('click', performGradeCalculation);
            }
            
            // Cerrar modal al hacer click en el fondo
            if (gradeCalculatorModal) {
                gradeCalculatorModal.addEventListener('click', function(e) {
                    if (e.target === gradeCalculatorModal) {
                        closeGradeCalculator();
                    }
                });
            }
            
            // Gestor de Tareas
            const addTaskFab = document.getElementById('addTaskFab');
            const taskModal = document.getElementById('taskModal');
            const closeTaskModalBtn = document.getElementById('closeTaskModalBtn');
            const saveTaskBtn = document.getElementById('saveTaskBtn');
            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            
            if (addTaskFab) {
                addTaskFab.addEventListener('click', () => openTaskModal());
            }
            
            if (closeTaskModalBtn) {
                closeTaskModalBtn.addEventListener('click', closeTaskModal);
            }
            
            if (saveTaskBtn) {
                saveTaskBtn.addEventListener('click', saveTask);
            }
            
            if (cancelTaskBtn) {
                cancelTaskBtn.addEventListener('click', closeTaskModal);
            }
            
            // Cerrar modal al hacer click en el fondo
            if (taskModal) {
                taskModal.addEventListener('click', function(e) {
                    if (e.target === taskModal) {
                        closeTaskModal();
                    }
                });
            }
            
            // Modal de Ajustes
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', () => {
                    settingsModal.classList.add('hidden');
                    settingsModal.classList.remove('flex');
                });
            }
            
            // Cerrar modal al hacer click en el fondo
            if (settingsModal) {
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === settingsModal) {
                        settingsModal.classList.add('hidden');
                        settingsModal.classList.remove('flex');
                    }
                });
            }
            
            // Event delegation para tareas din√°micas
            const userTasksContainer = document.getElementById('userTasksContainer');
            const taskHistoryContainer = document.getElementById('taskHistoryContainer');
            
            if (userTasksContainer) {
                userTasksContainer.addEventListener('click', function(e) {
                    const actionBtn = e.target.closest('[data-action]');
                    if (!actionBtn) return;
                    
                    const action = actionBtn.getAttribute('data-action');
                    const taskId = actionBtn.getAttribute('data-task-id');
                    
                    switch (action) {
                        case 'toggle-complete':
                            toggleTaskComplete(taskId);
                            break;
                        case 'edit-task':
                            openTaskModal(taskId);
                            break;
                        case 'delete-task':
                            deleteTask(taskId);
                            break;
                    }
                });
            }
            
            // TAREA #3 v1.1: Event listeners para historial de tareas
            if (taskHistoryContainer) {
                taskHistoryContainer.addEventListener('click', function(e) {
                    const actionBtn = e.target.closest('[data-action]');
                    if (!actionBtn) return;
                    
                    const action = actionBtn.getAttribute('data-action');
                    const taskId = actionBtn.getAttribute('data-task-id');
                    
                    switch (action) {
                        case 'toggle-complete':
                            toggleTaskComplete(taskId);
                            break;
                        case 'delete-task':
                            deleteTask(taskId);
                            break;
                    }
                });
            }
            
            // Toggle del historial
            const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
            const historyToggleIcon = document.getElementById('historyToggleIcon');
            
            if (toggleHistoryBtn && taskHistoryContainer && historyToggleIcon) {
                toggleHistoryBtn.addEventListener('click', () => {
                    const isHidden = taskHistoryContainer.classList.contains('hidden');
                    if (isHidden) {
                        taskHistoryContainer.classList.remove('hidden');
                        historyToggleIcon.classList.remove('fa-chevron-down');
                        historyToggleIcon.classList.add('fa-chevron-up');
                    } else {
                        taskHistoryContainer.classList.add('hidden');
                        historyToggleIcon.classList.remove('fa-chevron-up');
                        historyToggleIcon.classList.add('fa-chevron-down');
                    }
                });
            }

            // Modal de Confirmaci√≥n
            const confirmModal = document.getElementById('confirmModal');
            
            if (confirmModal) {
                confirmModal.addEventListener('click', function(e) {
                    if (e.target === confirmModal) {
                        confirmModal.classList.add('hidden');
                        confirmModal.classList.remove('flex');
                    }
                });
            }
            
        });
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        function init() {
            // Inicializar tema antes que nada (para evitar flash)
            initTheme();
            
            // Cargar tareas del usuario
            loadUserTasks();
            
            // TAREA #3 v1.1: Limpieza autom√°tica de tareas antiguas (>7 d√≠as)
            cleanupOldCompletedTasks();
            
            // Verificar si hay datos guardados
            if (loadFromLocalStorage()) {
                showDashboard();
            } else {
                showSetup();
            }
            
            // Service Worker se puede agregar m√°s tarde con un archivo separado
            // Para usarlo, crear un archivo sw.js y registrarlo aqu√≠
            console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('  Mi Horario FPUNA v5.5 - REPARACI√ìN DE EMERGENCIA  ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('ÔøΩ TAREA #1: INTERACTIVIDAD REPARADA');
            console.log('  ‚úì ID discrepante corregido: closeModalBtn ‚Üí closeSettingsBtn');
            console.log('  ‚úì TODOS los addEventListener envueltos en condicionales if()');
            console.log('  ‚úì TypeError ELIMINADO - aplicaci√≥n ya no se rompe');
            console.log('');
            console.log('üö® TAREA #2: PARSER RECONSTRUIDO');
            console.log('  ‚úì Algoritmo de ex√°menes SIMPLIFICADO (mapeo directo)');
            console.log('  ‚úì Clases ocasionales con regex mejorado');
            console.log('  ‚úì Validaci√≥n robusta que no detiene el proceso');
            console.log('');
            console.log('üö® TAREA #3: FUNCIONALIDADES NO ESENCIALES DESHABILITADAS');
            console.log('  ‚è∏Ô∏è  Calculadora de Notas (COMENTADA temporalmente)');
            console.log('  ‚è∏Ô∏è  Gestor de Tareas (COMENTADO temporalmente)');
            console.log('  ‚úÖ ENFOQUE: Solo funcionalidad b√°sica del horario');
            console.log('');
            console.log('üéØ ESTADO: Base estable restaurada - listo para testing');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        }
        
        // Iniciar aplicaci√≥n
        init();
        
    </script>
</body>
</html>